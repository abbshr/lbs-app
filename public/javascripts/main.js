// Generated by CoffeeScript 1.9.3
(function() {
  window.info = function(lng, lat, accuracy) {
    return "当前位置: (" + lng + ", " + lat + "), 精确度: " + accuracy + "m\n";
  };

  window.mapInitialize = function(map, lng, lat, zoom) {
    var pos;
    pos = new AMap.LngLat(lng, lat);
    return map.setZoomAndCenter(zoom, pos);
  };

  window.getCurrency = function(map, geo, callback) {
    var accuracy, lat, lng;
    lng = 126.642464;
    lat = 45.756967;
    accuracy = Infinity;
    return geo.getCurrent(function(err, pos) {
      if (err != null) {
        console.log(err);
        return map.plugin('AMap.Geolocation', function() {
          var geolocation;
          geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,
            timeout: 6000,
            convert: true,
            zoomToAccuracy: true
          });
          map.addControl(geolocation);
          AMap.event.addListener(geolocation, 'complete', function(e) {
            lng = e.position.getLng();
            lat = e.position.getLat();
            accuracy = e.accuracy;
            mapInitialize(map, lng, lat, 13);
            callback(lng, lat);
            return console.info(info(lng, lat, accuracy));
          });
          AMap.event.addListener(geolocation, "error", function(e) {
            console.error(e.info);
            mapInitialize(map, lng, lat, 13);
            callback(lng, lat);
            return console.info(info(lng, lat, accuracy));
          });
          return geolocation.getCurrentPosition();
        });
      } else {
        lng = pos.longitude;
        lat = pos.latitude;
        accuracy = pos.accuracy;
        mapInitialize(map, lng, lat, 13);
        callback(lng, lat);
        return console.info(info(lng, lat, accuracy));
      }
    });
  };

  window.postNewInfo = function(form) {
    var formdata;
    formdata = new FormData(form);
    return fetch("/post", {
      method: 'POST',
      body: formdata
    });
  };

  window.onload = function(e) {
    $('#post-btn').click(function(e) {
      return $('#new-post').modal({
        blurring: true,
        onApprove: function() {
          $('#loader').addClass("active");
          setTimeout(function() {
            $('#new-post').modal('hide');
            return $('#loader').removeClass("active");
          }, 3000);
          return false;
        }
      }).modal('show');
    });
    this.map = new AMap.Map("map");
    this.geo = new Geo({
      timeout: 1000
    });
    return getCurrency(this.map, this.geo, function(lng, lat) {
      var distance, limit;
      distance = 1000;
      limit = 100;
      return fetch("/api/near?lng=" + lng + "&lat=" + lat + "&distance=" + distance + "&limit=" + limit).then(function(res) {
        if (res.ok) {
          return res.json().then(function(res) {
            if (res.success) {
              return console.log(res.posts);
            } else {
              return console.error(res.error);
            }
          });
        }
      })["catch"](function(err) {
        return console.error(err);
      });
    });
  };

}).call(this);
