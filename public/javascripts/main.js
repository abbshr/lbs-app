// Generated by CoffeeScript 1.9.3
(function() {
  var LbsApp, info, rescb;

  LbsApp = {};

  info = function(lng, lat, accuracy) {
    return "当前位置: (" + lng + ", " + lat + "), 精确度: " + accuracy + "m\n";
  };

  rescb = function(res) {
    if (res.ok) {
      return res.json();
    } else {
      throw new Error(res.status);
    }
  };

  LbsApp.mapInitialize = function(map, lng, lat, zoom) {
    var pos;
    pos = new AMap.LngLat(lng, lat);
    return map.setZoomAndCenter(zoom, pos);
  };

  LbsApp.getCurrency = function(map, geo) {
    var accuracy, lat, lng, thirdPardApi;
    lng = 126.642464;
    lat = 45.756967;
    accuracy = Infinity;
    thirdPardApi = new Promise(function(resolve) {
      return map.plugin('AMap.Geolocation', function() {
        var geolocation;
        geolocation = new AMap.Geolocation({
          enableHighAccuracy: true,
          timeout: 6000,
          convert: true,
          zoomToAccuracy: true
        });
        map.addControl(geolocation);
        AMap.event.addListener(geolocation, 'complete', function(e) {
          lng = e.position.getLng();
          lat = e.position.getLat();
          accuracy = e.accuracy;
          return resolve({
            lng: lng,
            lat: lat,
            accuracy: accuracy
          });
        });
        AMap.event.addListener(geolocation, "error", function(e) {
          console.error(e.info);
          return resolve({
            lng: lng,
            lat: lat,
            accuracy: accuracy
          });
        });
        return geolocation.getCurrentPosition();
      });
    });
    return new Promise(function(resolve, reject) {
      return geo.getCurrent(function(err, pos) {
        if (err != null) {
          console.log(err);
          return resolve(thirdPardApi);
        } else {
          lng = pos.longitude;
          lat = pos.latitude;
          accuracy = pos.accuracy;
          return resolve({
            lng: lng,
            lat: lat,
            accuracy: accuracy
          });
        }
      });
    });
  };

  LbsApp.createPost = function(form) {
    var formdata;
    formdata = new FormData(form);
    return fetch("/post", {
      method: 'POST',
      body: formdata,
      credentials: 'same-origin'
    }).then(function(res) {
      return rescb(res);
    });
  };

  LbsApp.getNearBy = function(lng, lat, distance, limit) {
    if (distance == null) {
      distance = 1000;
    }
    if (limit == null) {
      limit = 200;
    }
    return fetch("/api/near?lng=" + lng + "&lat=" + lat + "&distance=" + distance + "&limit=" + limit).then(function(res) {
      return rescb(res);
    });
  };

  LbsApp.getPost = function(postId) {
    return fetch("/post?postId=" + postId).then(function(res) {
      return rescb(res);
    });
  };

  LbsApp.getUserMap = function(username) {
    return fetch("/map?user=" + username).then(function(res) {
      return rescb(res);
    });
  };

  LbsApp.login = function(user) {
    return fetch("/login", {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(user),
      credentials: 'same-origin'
    }).then(function(res) {
      return rescb(res);
    });
  };

  LbsApp.registy = function(user) {
    return fetch("/registy", {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(user),
      credentials: 'same-origin'
    }).then(function(res) {
      return rescb(res);
    });
  };

  LbsApp.logout = function() {
    return fetch("/logout", {
      credentials: 'same-origin'
    }).then(function(res) {
      return rescb(res);
    });
  };

  window.onload = function(e) {
    $('#post-btn').click(function(e) {
      return $('#new-post').modal({
        blurring: true,
        onApprove: function() {
          $('#loader').addClass("active");
          setTimeout(function() {
            $('#new-post').modal('hide');
            return $('#loader').removeClass("active");
          }, 3000);
          return false;
        }
      }).modal('show');
    });
    this.map = new AMap.Map("map");
    this.geo = new Geo({
      timeout: 1000
    });
    return LbsApp.getCurrency(this.map, this.geo).then(function(pos) {
      var accuracy, lat, lng;
      lng = pos.lng, lat = pos.lat, accuracy = pos.accuracy;
      console.info(info(lng, lat, accuracy));
      LbsApp.mapInitialize(map, lng, lat, 13);
      return LbsApp.getNearBy(lng, lat, 1000, 50);
    }).then(function(data) {
      if (data.success) {
        return console.log(data);
      }
    })["catch"](function(err) {
      return console.error(err);
    });
  };

  window.LbsApp = LbsApp;

}).call(this);
